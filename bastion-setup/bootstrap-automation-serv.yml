---

##### To run on the local machine i.e workstation
- name: Prepare the Automation server
  hosts: bastion_pub
  gather_facts: no
  become: true 
  remote_user: "bastion"
  
  pre_tasks:
    - name: Install python for Ansible
      raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
      changed_when: False
      
  roles:
    - common
    - configGenerationTools
  

- name: Transfer bastion server playbook components
  hosts: bastion_pub
  remote_user: "bastion"
  become: true
  tasks:
    - name: Ensure group "bastion" exists
      group:
        name: bastion
        state: present
    - name: Add the user 'bastion' and a primary group of 'bastion'
      user:
        name: bastion
        comment: bastion local user
        group: bastion
    - name: Create CertDir
      file:
        path: /automation/CertDir
        state: directory  
        owner: bastion
        group: bastion
    - name: Copy ansible Inventory
      copy:
        src: ./inventories
        dest: /automation/
        owner: bastion
        group: bastion
        mode: '0755' 

    - name: Copy all ansible Roles
      copy:
        src: ./roles
        dest: /automation/
        owner: bastion
        group: bastion
        mode: '0755' 
    
    - name: Copy install kube Cluster playbook
      copy:
        src: configure-cluster.yml
        dest: /automation/configure-cluster.yml
        owner: bastion
        group: bastion
        mode: '0755' 
   
    - name: Copy tlscertGenAndTransfer playbook
      copy:
        src: tlscertGenAndTransfer.yml
        dest: /automation/tlscertGenAndTransfer.yml
        owner: bastion
        group: bastion
        mode: '0755' 
    - name: Copy reboot_all playbook
      copy:
        src: reboot_all.yml
        dest: /automation/reboot_all.yml
        owner: bastion
        group: bastion
        mode: '0755' 
    - name: Copy over playbook vars to automation server
      copy:
        src: ./vars
        dest: /automation/
        owner: bastion
        group: bastion
        mode: '0755'

    - name: Copy over ssh keys to automation server
      vars_files:
        - vars/main.yml
      import_role:
        name: sshkeygen

